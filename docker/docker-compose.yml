# mfmf manage -j in all docker-compose.yml
# mfmf specify dependencies on services (build and run dependencies)
version: "2"



services:
  base:
    image: mbsimenv/base
    build: baseImage

  build:
    image: mbsimenv/build
    build: buildImage

  run:
    image: mbsimenv/run
    build:
      context: ..
      dockerfile: docker/runImage/Dockerfile

  autobuild-linux64-ci:
    image: mbsimenv/autobuild
    build:
      context: ..
      dockerfile: docker/autoBuildImage/Dockerfile
    entrypoint: ["/mbsim-build/build/docker/autoBuildImage/entrypoint.py", "--buildType", "linux64-ci"]
    environment:
      - MBSIMENVSERVERNAME
    volumes:
      - autobuild-mbsim-linux64-ci:/mbsim-env # no name needed since not used by other services
      - autobuild-report-linux64-ci:/mbsim-report
      - autobuild-ccache:/mbsim-ccache
      - autobuild-state:/mbsim-state
      - autobuild-config:/mbsim-config:ro

  autobuild-linux64-dailydebug:
    image: mbsimenv/autobuild
    build:
      context: ..
      dockerfile: docker/autoBuildImage/Dockerfile
    entrypoint: ["/mbsim-build/build/docker/autoBuildImage/entrypoint.py", "--buildType", "linux64-dailydebug",
                 "--buildDoc", "--valgrindExamples"]
    environment:
      - MBSIMENVSERVERNAME
    volumes:
      - autobuild-mbsim-linux64-dailydebug:/mbsim-env # no name neede since not used by oher services
      - autobuild-report-linux64-dailydebug:/mbsim-report
      - autobuild-ccache:/mbsim-ccache
      - autobuild-state:/mbsim-state
      - autobuild-config:/mbsim-config

  autobuild-linux64-dailyrelease:
    image: mbsimenv/autobuild
    build:
      context: ..
      dockerfile: docker/autoBuildImage/Dockerfile
    command: ["--buildType", "linux64-dailyrelease"]
    entrypoint: ["/mbsim-build/build/docker/autoBuildImage/entrypoint.py", "--buildType", "linux64-dailyrelease"]
    environment:
      - MBSIMENVSERVERNAME
    volumes:
      - autobuild-mbsim-linux64-dailyrelease:/mbsim-env # no name neede since not used by oher services
      - autobuild-report-linux64-dailyrelease:/mbsim-report
      - autobuild-ccache:/mbsim-ccache
      - autobuild-state:/mbsim-state
      - autobuild-config:/mbsim-config:ro

  webserver:
    image: mbsimenv/webserver
    build:
      context: ..
      dockerfile: docker/webServerImage/Dockerfile
    hostname: ${MBSIMENVSERVERNAME}
    environment:
      - MBSIMENVSERVERNAME
    volumes:
      - autobuild-report-linux64-ci:/var/www/html/mbsim/linux64-ci:ro
      - autobuild-report-linux64-dailydebug:/var/www/html/mbsim/linux64-dailydebug:ro
      - autobuild-report-linux64-dailyrelease:/var/www/html/mbsim/linux64-dailyrelease:ro
      - autobuild-state:/var/www/html/mbsim/buildsystemstate:ro
      - autobuild-config:/mfmf/BuildServiceConfig
      - webserver-releases:/var/www/html/mbsim/releases
      - webserver-letsencrypt:/etc/letsencrypt
    ports:
      - "80:80"
      - "443:443"



volumes:
  autobuild-mbsim-linux64-ci: # not needed but provided to provide a proper name
  autobuild-report-linux64-ci:
  autobuild-mbsim-linux64-dailydebug: # not needed but provided to provide a proper name
  autobuild-report-linux64-dailydebug:
  autobuild-mbsim-linux64-dailyrelease: # not needed but provided to provide a proper name
  autobuild-report-linux64-dailyrelease:
  autobuild-state:
  autobuild-config:
  autobuild-ccache:
  webserver-releases:
  webserver-letsencrypt:
